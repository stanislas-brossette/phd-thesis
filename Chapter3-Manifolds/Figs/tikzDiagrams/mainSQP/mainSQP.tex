\documentclass{article}
\usepackage[utf8]{inputenc}

\title{mainSQP}
\author{stanislas.brossette }
\date{May 2016}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows}
\begin{document}

\tikzstyle{startstop} = [rectangle, rounded corners, text centered, draw=black, fill=red!30]
\tikzstyle{io} = [trapezium, trapezium left angle=70, trapezium right angle=110, text centered, draw=black, fill=blue!30]
\tikzstyle{process} = [rectangle, text centered, draw=black, fill=orange!30]
\tikzstyle{decision} = [rectangle, text centered, draw=black, fill=green!30]
\tikzstyle{arrow} = [thick,->,>=stealth]

\begin{tikzpicture}[node distance=1.5cm]

\node (init) [startstop] {Init $x$ and filter};
\node (update) [process, below of=init] {Update $c$, $\nabla c$, $f$, $\nabla f$, $H$\ldots};
\node (KKT) [decision, below of=update] {Is KKT satisfied?};
\node (success) [startstop, below of=KKT, xshift=3cm, text width=2cm] {Convergence Success};
\node (FP) [decision, below of=KKT, text width=3cm] {Solve FP. Is problem feasible?};
\node (QP) [process, below of=FP, xshift=-1cm] {Solve QP};
\node (restoration) [process, below of=FP, text width=3cm, xshift=2cm, yshift=-0.5cm] {Find feasible point with Restoration Phase};
\node (forceAdd) [process, below of=restoration, text width=3cm, yshift=-0.5cm] {Force add $\{f(x),c(x)\}$ in filter};
\node (zeroStep) [decision, below of=QP] {Is $\|\mathbf{z}\| \leq \epsilon$};
\node (success2) [startstop, below of=zeroStep, xshift=-1cm, text width=2cm] {Null step Success};
\node (filterTest) [decision, below of=zeroStep, text width=4cm, yshift=-1.5cm, xshift=1cm] {Is $\{f(\varphi_x(z)),c(\varphi_x(z))\}$ accepted by filter};
\node (reduceTR) [process, below of=filterTest, xshift=-2cm] {\begin{tabular}{c}Reduce trust region\\ $\rho\leftarrow\frac{\rho}{2}$\end{tabular}};
\node (smallStepTest) [decision, below of=reduceTR] {Is $\rho \leq \rho_{min}$ };
\node (fail) [startstop, below of=smallStepTest, xshift=1.5cm] {\begin{tabular}{c}Too small step\\
Failure\end{tabular}};
\node (addToFilter) [process, below of=filterTest, xshift=2cm] {$x\leftarrow\varphi_x(z)$ Add to filter};
\node (limitedStep) [decision, below of=addToFilter, xshift=1cm] {Is step limited by trust region};
\node (increaseTR) [process, below of=limitedStep, xshift=-1cm] {$\rho\leftarrow 2 \rho$};


\draw [arrow] (init) -- (update);
\draw [arrow] (update) -- (KKT);
\draw [arrow] (KKT) -- node[anchor=east] {no} (FP);
\draw [arrow] (KKT) -- node[anchor=west] {yes} (success);
\draw [arrow] (FP) -- node[anchor=east] {yes} (QP);
\draw [arrow] (FP) -- node[anchor=west] {no} (restoration);
\draw [arrow] (restoration) -- node[anchor=west] {$x$} (forceAdd);
\draw [arrow] (forceAdd) -- (update);
\draw [arrow] (QP) -- node[anchor=west] {$\bf z$} (zeroStep);
\draw [arrow] (zeroStep) -- node[anchor=east] {yes} (success2);
\draw [arrow] (zeroStep) -- node[anchor=west] {no} (filterTest);
\draw [arrow] (filterTest) -- node[anchor=east] {no} (reduceTR);
\draw [arrow] (filterTest) -- node[anchor=west] {yes}  (addToFilter);
\draw [arrow] (reduceTR) -- (smallStepTest);
\draw [arrow] (addToFilter) -- (limitedStep);
\draw [arrow] (smallStepTest) -- (fail);
\draw [arrow] (limitedStep) -- (increaseTR);
\draw [arrow] (increaseTR) -- (update);
\draw [arrow] (limitedStep) -- (update);
\draw [arrow] (smallStepTest) -- (update);

\end{tikzpicture}


\end{document}
